id,title,spec
C00-01,"Bootstrap: remove missing Features references","In `whatsapp-commerce-hub.php`, remove/replace runtime references to non-existent `WhatsAppCommerceHub\\Features\\*` classes (e.g., RefundService, OrderNotifications, ReengagementService). Use the real services/providers that exist in this repo. Acceptance: plugin loads without PHP fatal; `rg 'WhatsAppCommerceHub\\\\Features\\\\' whatsapp-commerce-hub.php` returns no matches; activation succeeds."
C00-02,"Bootstrap: single initialization path","Consolidate plugin initialization so providers own initialization; reduce/remove duplicated work in `WhatsAppCommerceHubPlugin::init()` and avoid initializing the same subsystems both in providers and the singleton. Acceptance: no double-init of admin pages, queues, or schedulers; one clear boot path documented; tests still pass."
C00-03,"Bootstrap: requirements gating","Ensure requirements checks (PHP/WP/WC) happen before container/provider boot and before any WooCommerce-dependent services run. Keep admin notice behavior consistent. Acceptance: on unmet requirements, plugin does not boot container, does not register hooks that assume WC; shows a single admin notice."
C00-04,"Bootstrap: ErrorHandler boot sequencing","Refactor `Core\\ErrorHandler` initialization so it does not require the container too early and does not call missing services when WP is not fully ready. Prefer injecting `LoggerInterface` via provider boot. Acceptance: no container access during file load; fatal/exception handling still logs; unit tests cover init/reset paths."
C00-05,"Container: resolve alias/binding collisions","Audit container bindings/aliases for collisions (e.g., duplicate `'wch.checkout'` registrations in different providers) and fix by renaming aliases or removing duplicates. Add a lightweight guard (dev-only) that can detect duplicate alias usage during provider registration. Acceptance: no duplicated alias keys across providers; container boot is deterministic."
C00-06,"Settings: deprecate `wch.settings` flat schema","Replace the flat `wch.settings`/`wch.setting` schema in `Providers\\CoreServiceProvider` with a compatibility adapter over `SettingsInterface` (sectioned keys like `api.whatsapp_phone_number_id`). Add deprecation notes in code/docs. Acceptance: all settings reads can be routed through `SettingsInterface`; legacy helpers still work during transition."
C00-07,"Settings: update API client wiring","Update `Providers\\ApiClientServiceProvider` to use `SettingsInterface` sectioned keys (`api.whatsapp_phone_number_id`, `api.access_token`, `ai.openai_api_key`, etc.) and remove dependence on the legacy flat settings array. Acceptance: WhatsApp/OpenAI clients fail fast with clear errors when not configured; no mismatched key usage remains."
C00-08,"Settings: eliminate direct `get_option('wch_settings')` usage","Audit `includes/` for direct option reads and migrate them to `SettingsInterface` (or a dedicated repository) so config is centralized. Acceptance: `rg \"get_option\\(\\s*'wch_settings'\" includes` returns zero (or only within SettingsManager); behavior unchanged."
C00-09,"DB: inventory tables and owners doc","Create/refresh a doc (e.g., `docs/db-schema.md`) listing every table the plugin uses, which module owns it, and where it is created/updated/uninstalled. Acceptance: doc includes tables referenced by Security, Queue, Payment webhooks, and core feature tables."
C00-10,"DB: implement a real migrations mechanism","Populate `includes/Infrastructure/Database/Migrations/` with a migration interface/base and wire it into `DatabaseManager` so schema changes are versioned and testable. Acceptance: migrations run in order; DB version is updated; migrations are idempotent via `dbDelta` where appropriate."
C00-11,"DB: add missing tables used at runtime","Add schema + install/uninstall support for missing tables currently referenced in code: `wch_rate_limits`, `wch_security_log`, `wch_webhook_idempotency`, and `wch_webhook_events` (and any others found in the table inventory). Acceptance: enabling Security/RateLimiter/Idempotency/Payment webhooks does not hit missing-table errors."
C00-12,"DB: uninstall cleanup completeness","Update `uninstall.php` / `DatabaseManager::uninstall()` to remove newly added tables and related options/transients safely (without deleting user data unexpectedly beyond documented scope). Acceptance: uninstall leaves no plugin tables/options behind per policy; behavior documented."
C00-13,"Queue: pick one async system and enforce it","Decide and implement a single async pipeline (recommended: `Queue\\PriorityQueue` + processors with wrapped payloads). Deprecate or adapt `Infrastructure\\Queue\\QueueManager`/`JobDispatcher` to the same conventions. Acceptance: all scheduled jobs use one payload format; all job handlers receive the expected args shape."
C00-14,"Queue: audit Action Scheduler hook signatures","Audit every `add_action('wch_*', ...)` handler to ensure its function signature matches the scheduled payload structure (including wrapped payloads). Fix mismatches and add minimal runtime assertions/logs in processors. Acceptance: no job crashes due to args shape; add tests for at least the webhook jobs."
C00-15,"Docs: boot path diagram and explanation","Add a dedicated doc describing the boot sequence (requirements → container/providers → context-specific boot). Link it from `docs/README.md`. Acceptance: doc is accurate and references real files/classes."
C00-16,"Repo hygiene: empty directories policy","Either remove empty placeholder directories or add `README.md` files explaining their intended use and migration plan. Acceptance: no empty directories without purpose; contributors can tell what is planned vs implemented."
C01-01,"ADR: choose canonical models (Domain vs Entities/ValueObjects)","Write an ADR-style note deciding which layer owns canonical representations of Cart/Customer/Conversation/Intent/Context, and what the other layer’s role is (DTO, persistence model, etc.). Acceptance: decision documented; team can follow it."
C01-02,"Refactor: remove Domain/Entity duplication where possible","Based on the ADR, refactor code to use canonical models consistently and introduce adapters/mappers where needed. Acceptance: reduced duplication; fewer parallel types; tests updated."
C01-03,"Refactor: consolidate Intent/Context types","Unify `Intent`/`ConversationContext`/`Context` usage across Domain/Application/Queue processors; eliminate multiple competing representations. Acceptance: one canonical intent/context type used in processors and application services."
C01-04,"Guardrail: Domain must not call WordPress APIs","Add PHPStan rules/config to forbid WordPress/global functions in `includes/Domain/**` (e.g., `do_action`, `get_option`, `$wpdb`). Fix violations or move code into Infrastructure. Acceptance: phpstan passes; rule is documented."
C01-05,"Logging: standardize on `LoggerInterface` injection","Refactor services/providers to depend on `Contracts\\Services\\LoggerInterface` rather than `Logger::instance()` or ad-hoc anonymous loggers. Keep fallbacks only in Core where necessary. Acceptance: logging calls are consistent; improved testability."
C01-06,"DI discipline: reduce `wch()` service locator usage","Remove `wch()` usage from providers and internal services where possible; use constructor injection and explicit `$container` usage. Keep global helpers only at integration boundaries. Acceptance: fewer hidden dependencies; tests can instantiate services without globals."
C01-07,"Error taxonomy: consistent exceptions per layer","Define a minimal exception taxonomy (Domain vs Application vs Infrastructure) and refactor key hotspots to throw/catch appropriately. Acceptance: predictable error handling; processors can decide retry vs DLQ based on exception type."
C02-01,"Docs: module map","Create `docs/module-map.md` listing each module (Webhooks, Conversations/FSM, Catalog, Product Sync, Checkout, Payments, Broadcasts, Reengagement, Admin, Monitoring, Security) with: provider entrypoint, key contracts, tables, jobs, hooks. Acceptance: accurate and linked from `docs/README.md`."
C02-02,"Module: Webhooks ingestion pipeline","Define/clarify contracts and ownership for inbound webhooks (REST controller → queue → processors → actions). Ensure the module uses the unified queue payload format and documents extension hooks. Acceptance: webhook flow is documented and test-covered."
C02-03,"Module: Conversations + FSM + Actions","Clarify the action routing surface (`Actions\\ActionRegistry`, handlers, FSM/state machine) and provide stable extension points. Add/adjust contracts if needed. Acceptance: actions can be extended without touching core; documentation reflects current code."
C02-04,"Module: Catalog browsing API alignment","Reconcile `CATALOG_BROWSER_USAGE.md` and any legacy references (e.g., missing `includes/class-wch-catalog-browser.php`) with the real catalog browsing implementation (e.g., `Domain\\Catalog\\CatalogBrowser` and related actions). Acceptance: docs point to real classes/files; tests cover basic browsing outputs."
C02-05,"Module: Product Sync boundaries and contracts","Tighten Product Sync wiring (validator/transformer/api/tracker/orchestrator/admin UI). Ensure queue hooks match payload shapes and settings keys are consistent. Acceptance: Product Sync can run end-to-end; admin UI uses Application services; docs updated."
C02-06,"Module: Checkout vs Saga responsibilities","Clarify the relationship between `Checkout\\CheckoutOrchestrator`, `Application\\Services\\Checkout\\CheckoutOrchestrator`, and `Sagas\\CheckoutSaga`. Remove/confine overlap and fix alias naming conflicts. Acceptance: one clear entrypoint for checkout orchestration; no ambiguous aliases."
C02-07,"Module: Payments architecture cleanup","Unify payment gateway registration, webhooks, refunds, and notifications. Fix `PaymentServiceProvider` duplication/confusion around NotificationService registration and ensure PaymentWebhookController persistence/idempotency is backed by schema. Acceptance: payment flows are consistent; no dead code paths; docs updated."
C02-08,"Module: Broadcasts persistence and async processing","Document current persistence (options) and decide whether to migrate to tables; ensure batch processing uses unified queue conventions and admin UI boundaries are clear. Acceptance: broadcast scheduling is reliable; storage choice documented; tests cover campaign CRUD."
C02-09,"Module: Reengagement provider DI cleanup","Remove global `wch()` calls inside Reengagement provider/services; use container injection and consistent settings/database APIs. Ensure scheduled jobs are documented and payload schemas are stable. Acceptance: reengagement tasks schedule and run without globals; tests cover orchestrator init."
C02-10,"Module: Monitoring/Health extensibility","Ensure health checks are modular, composable, and don’t require booting unrelated subsystems. Document endpoints and permissions. Acceptance: health endpoints work in minimal context; checks list is discoverable."
C02-11,"Module: Security + data protection completeness","Ensure SecureVault/PIIEncryptor/RateLimiter have complete schema support, rotation paths are safe, and logging doesn’t fail due to missing tables. Document the security model. Acceptance: security features can be enabled without runtime errors; docs reflect actual behavior."
C03-01,"Providers: dependency metadata and topological boot ordering","Add optional dependency declarations for providers (e.g., `dependsOn()`), then topologically sort provider registration/boot in `wch_get_container()`. Fail fast on cycles/missing deps. Acceptance: provider order issues are eliminated; errors are actionable."
C03-02,"Providers: container boot diagnostics","Add a diagnostics endpoint or admin page that lists providers, bindings, aliases, and boot status (dev-only or capability-gated). Acceptance: debugging provider wiring is straightforward."
C03-03,"Providers: context-aware boot gating","Make provider boot conditional where appropriate (admin vs REST vs cron) to reduce overhead and avoid unintended side effects. Acceptance: no heavy init on frontend requests; functionality still works when needed."
C03-04,"Providers: ban `wch()` usage in providers","Refactor providers to use the injected `$container` exclusively (no `wch()` inside providers). Add a lint/grep check or PHPStan rule to prevent regressions. Acceptance: providers are deterministic and testable."
C03-05,"Container: detect accidental overrides","Add optional debug logging or a dev-mode guard in the container to detect when a binding/alias is overwritten during provider registration. Acceptance: accidental overrides are caught early in development."
C04-01,"Async: finalize unified job system","Complete the unification so one scheduling API is used across the plugin; remove or clearly wrap secondary job APIs. Acceptance: job scheduling is consistent; job definitions are centralized and documented."
C04-02,"Async: define versioned payload schemas","Introduce DTO-like payload structures (even as validated arrays) for key jobs (webhook message/status/error, product sync, notifications, broadcasts, reengagement). Include versioning and validation. Acceptance: payload drift is prevented; upgrades are possible."
C04-03,"Async: standardize idempotency + DLQ semantics","Align idempotency keys/scopes and DLQ reasons across all processors. Ensure retry policies are consistent and based on exception taxonomy. Acceptance: fewer duplicate-process bugs; DLQ entries are actionable."
C04-04,"Events: harmonize EventBus vs WordPress hooks","Define which events are internal (EventBus) vs extension points (WP hooks). Refactor mixed usage where it causes type drift (Domain vs Entities). Acceptance: event contracts are stable; async event processing is predictable."
C04-05,"Docs: job catalog","Create `docs/job-catalog.md` listing every job hook, payload schema, priority, idempotency key, retry policy, and DLQ behavior. Acceptance: doc is accurate and linked from module map."
C05-01,"REST: standardize controllers on AbstractController","Migrate REST controllers to consistently use `Controllers\\AbstractController` patterns (permissions, rate limiting, CORS, response helpers). Acceptance: consistent auth/rate limiting across endpoints; less duplicated code."
C05-02,"REST: refactor PaymentWebhookController to shared patterns","Refactor `Controllers\\PaymentWebhookController` to reuse shared controller utilities (rate limit, logging, error response format). Ensure idempotency is robust and storage-backed as designed. Acceptance: secure, consistent webhook handling with clear logs."
C05-03,"Admin UI: choose one home and migrate Settings first","Pick either `includes/Admin/*` or `includes/Presentation/Admin/*` as the canonical admin layer and migrate one module (Settings) end-to-end, keeping BC shims if needed. Acceptance: one clear admin architecture; reduced duplication."
C05-04,"Admin UI: centralize assets + API auth/nonce handling","Centralize enqueueing of admin JS/CSS and standardize REST/API auth/nonce/API-key handling. Acceptance: fewer ad-hoc enqueues; admin pages share a consistent client setup."
C06-01,"Docs/tests drift: remove legacy references to missing files","Update or deprecate docs/tests that refer to old WCH_* files or paths that do not exist (e.g., `README-PLUGIN.md`, `CATALOG_BROWSER_USAGE.md`, `SETTINGS_DOCUMENTATION.md`, tests expecting legacy files). Acceptance: docs match repo; tests do not reference missing classes/files."
C06-02,"Tests: Settings encryption + schema","Add unit tests for `Infrastructure\\Configuration\\SettingsManager` and `Application\\Services\\SettingsService` covering encrypted fields, defaults, cache invalidation, and failure modes. Acceptance: tests pass and prevent settings regressions."
C06-03,"Tests: PriorityQueue payload wrap/unwrap + retry","Add unit tests for `Queue\\PriorityQueue` payload versioning, unwrap errors, and retry path in `Queue\\Processors\\AbstractQueueProcessor`. Acceptance: payload drift causes test failures; retry/DLQ behavior is covered."
C06-04,"Tests: provider boot order/toposort","Add tests for provider dependency sorting and failure cases (cycle/missing dependency). Acceptance: ordering bugs are caught in CI."
C06-05,"Integration: webhook ingestion happy path","Add/adjust an integration test verifying webhook POST → controller → queue scheduling → processor execution (mocked where necessary). Acceptance: one end-to-end test covers the primary message flow."
C06-06,"CI: run lint/analyze/test","Add/adjust GitHub Actions workflows to run `composer lint`, `composer analyze`, and `composer test` (or appropriate subsets) on PRs. Acceptance: CI reliably gates merges."
C06-07,"Quality: baseline reduction + architecture checks","Establish a plan to reduce `phpstan-baseline.neon` over time and add architecture checks (e.g., Domain-no-WP rule). Acceptance: new issues are prevented; baseline shrinks incrementally."
C07-01,"Docs: rewrite extending guide to current architecture","Rewrite `docs/extending.md` to reflect provider-based extension (`wch_container_registered`), current contracts, and current hook names. Remove legacy WCH_* examples or mark them as deprecated. Acceptance: extension docs compile against real code."
C07-02,"Examples: add-on plugin sample","Add an `examples/` add-on plugin demonstrating: registering a provider via `wch_container_registered`, adding a custom action handler, and adding a custom REST endpoint using shared controller patterns. Acceptance: example is runnable and referenced in docs."
C07-03,"Docs: update/retire legacy top-level guides","Update `README-PLUGIN.md`, `CATALOG_BROWSER_USAGE.md`, and `SETTINGS_DOCUMENTATION.md` to either match current namespaced architecture or clearly mark them deprecated with pointers to the correct docs. Acceptance: no misleading docs remain."
C07-04,"Docs: navigation refresh","Update `docs/README.md` to link to the boot path doc, module map, DB schema doc, and job catalog. Acceptance: new contributors can navigate architecture docs quickly."
