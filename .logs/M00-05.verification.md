# M00-05 Verification Guide

## Quick Verification

Run the test script to verify the logging system:

```bash
php test-logging.php
```

Expected output:
- All 8 tests should pass
- Log file created with proper format
- Sensitive data redacted in logs
- Exception handling working correctly

## Manual Testing Steps

### 1. Test Basic Logging

```php
// Add to any plugin file
WCH_Logger::debug('Debug test', array('user' => 'admin'));
WCH_Logger::info('Info test', array('action' => 'view'));
WCH_Logger::warning('Warning test', array('issue' => 'minor'));
WCH_Logger::error('Error test', array('error' => 'something'));
WCH_Logger::critical('Critical test', array('alert' => 'major'));
```

Verify:
- Log file created in `wp-content/uploads/wch-logs/wch-{date}.log`
- Each message has proper format with timestamp, level, request ID
- Debug only appears when WP_DEBUG is true

### 2. Test Sensitive Data Sanitization

```php
WCH_Logger::info('Login attempt', array(
    'username' => 'test@example.com',
    'password' => 'secret123',
    'access_token' => 'abc123xyz',
    'user_ip' => '192.168.1.1'
));
```

Verify:
- Password shows as `***REDACTED***`
- Access token shows as `***REDACTED***`
- Username and IP are visible

### 3. Test Exception Handling

```php
try {
    throw new WCH_Exception(
        'Test exception',
        'test_error',
        400,
        array('test_id' => 123)
    );
} catch (WCH_Exception $e) {
    $e->log();
    // Or manually:
    // WCH_Logger::error($e->getMessage(), $e->get_context());
}
```

Verify:
- Exception logged with full context
- Stack trace included in debug mode
- Error code and HTTP status preserved

### 4. Test Admin Logs Viewer

1. Navigate to: **WooCommerce > WCH Logs**
2. Select a log file from dropdown
3. Verify log entries display with color coding:
   - Debug: Gray
   - Info: Blue
   - Warning: Yellow
   - Error: Red
   - Critical: Red with pink background
4. Filter by log level
5. Click "Refresh" to reload
6. Click "Delete Old Logs" to remove files older than 30 days

### 5. Test Error Handler

Create a test endpoint that triggers different error types:

```php
// Test 1: Uncaught exception
throw new Exception('Test uncaught exception');

// Test 2: PHP error (in debug mode becomes exception)
trigger_error('Test PHP error', E_USER_ERROR);

// Test 3: Fatal error
call_to_undefined_function();
```

Verify:
- All errors logged to WCH logs
- Debug mode shows detailed error info
- Production mode shows generic message
- AJAX/REST requests return JSON error responses

### 6. Test Log Rotation

```php
// Force log rotation test
WCH_Logger::delete_old_logs(0); // Delete all logs
```

Verify:
- All log files deleted
- New logs start fresh

### 7. Test Context Logging

```php
WCH_Logger::info('Order created from WhatsApp', array(
    'conversation_id' => 'conv_123',
    'customer_phone' => '+1234567890',
    'order_id' => 'WC-12345'
));
```

Verify:
- All context fields appear in log
- JSON format is valid
- Phone numbers not redacted (only sensitive keys)

### 8. Test Request ID Correlation

Make multiple log calls in the same request:

```php
WCH_Logger::info('Step 1');
WCH_Logger::info('Step 2');
WCH_Logger::info('Step 3');
```

Verify:
- All three entries have the same REQUEST_ID
- Different requests have different REQUEST_IDs

## Integration Testing

### 1. Test with REST API

```bash
# Make a request that would generate logs
curl -X POST http://localhost/wp-json/wch/v1/test \
  -H "Content-Type: application/json" \
  -d '{"test": "data"}'
```

Verify:
- Request logged with proper context
- Errors logged appropriately

### 2. Test with WooCommerce Logger

Check WooCommerce logs at: **WooCommerce > Status > Logs**

Verify:
- Error and Critical level logs appear in WooCommerce logs
- Source is 'whatsapp-commerce-hub'

### 3. Test Error Display

With WP_DEBUG=true and WP_DEBUG_DISPLAY=true:
- Trigger an exception
- Verify detailed HTML error page displayed

With WP_DEBUG=false:
- Trigger an exception
- Verify generic error message displayed

## File Verification

Check that files exist:

```bash
ls -la includes/class-wch-logger.php
ls -la includes/class-wch-exception.php
ls -la includes/class-wch-error-handler.php
ls -la includes/class-wch-admin-logs.php
ls -la test-logging.php
```

Check log directory structure:

```bash
ls -la wp-content/uploads/wch-logs/
# Should contain:
# - .htaccess (deny from all)
# - index.php (silence is golden)
# - wch-{date}.log files
```

## Performance Testing

### Test Log Rotation Performance

```php
// Create 100 log files
for ($i = 0; $i < 100; $i++) {
    WCH_Logger::info("Test log $i");
}

// Check that rotation doesn't slow down requests
// (Should run probabilistically, not every time)
```

### Test Large Context Arrays

```php
$large_context = array();
for ($i = 0; $i < 1000; $i++) {
    $large_context["key_$i"] = "value_$i";
}

WCH_Logger::info('Large context test', $large_context);
```

Verify:
- Logs written successfully
- No timeout issues

## Security Testing

### Test Direct File Access

Try to access log files directly:
```
http://your-site.com/wp-content/uploads/wch-logs/wch-2026-01-06.log
```

Should be blocked by .htaccess (403 Forbidden)

### Test Sensitive Data Patterns

Test various sensitive key patterns:

```php
WCH_Logger::info('Sensitive test', array(
    'PASSWORD' => 'test',
    'password' => 'test',
    'access_token' => 'test',
    'accessToken' => 'test',
    'access-token' => 'test',
    'api_key' => 'test',
    'apiKey' => 'test',
    'api-key' => 'test',
    'secret' => 'test',
    'auth' => 'test',
    'authorization' => 'test',
));
```

All should be redacted.

## Expected Results Summary

✓ Log files created in correct location with proper permissions
✓ All 5 log levels working (debug, info, warning, error, critical)
✓ Unique request IDs generated per request
✓ Sensitive data automatically redacted
✓ Admin page displays logs with filtering
✓ Old logs automatically deleted after 30 days
✓ Exceptions logged with full context and stack traces
✓ Error handler catches all error types
✓ WooCommerce integration working
✓ Performance impact minimal (probabilistic rotation)
✓ Security protections in place (.htaccess, permissions)

## Troubleshooting

### Logs not appearing
- Check WP_DEBUG is true for debug logs
- Check wp-content/uploads/wch-logs/ exists and is writable
- Check PHP error_log for permission issues

### Admin page not showing
- Verify user has 'manage_woocommerce' capability
- Check WCH_Admin_Logs::init() is called
- Clear browser cache

### Sensitive data not redacted
- Check pattern matches in sanitize_context()
- May need to add additional patterns

### Performance issues
- Check log rotation probability (default 1%)
- Consider increasing rotation threshold
- Check disk space for log files
