# M00-05 Usage Guide - Logging & Error Handling

## Quick Start

### Basic Logging

```php
// Import at the top (auto-loaded by class autoloader)
// Just use WCH_Logger directly

// Log at different severity levels
WCH_Logger::debug('Debugging information', array('variable' => $value));
WCH_Logger::info('General information', array('action' => 'completed'));
WCH_Logger::warning('Warning message', array('issue' => 'non-critical'));
WCH_Logger::error('Error occurred', array('error' => $error_msg));
WCH_Logger::critical('Critical failure', array('system' => 'payment'));
```

### Using Context

```php
// Recommended context keys for WhatsApp Commerce Hub
WCH_Logger::info('Message received from customer', array(
    'conversation_id' => $conversation->id,
    'customer_phone'  => $customer->phone,
    'message_type'    => 'text',
    'timestamp'       => time(),
));

WCH_Logger::info('Order created successfully', array(
    'conversation_id' => $conversation->id,
    'customer_phone'  => $customer->phone,
    'order_id'        => $order->get_id(),
    'total'           => $order->get_total(),
));
```

## Exception Handling

### Creating Exceptions

```php
// Throw a custom exception
throw new WCH_Exception(
    'Product not found in catalog',           // Message
    'product_not_found',                      // Error code
    404,                                      // HTTP status
    array(                                    // Context
        'product_id'   => $product_id,
        'search_term'  => $search_term,
    )
);
```

### Catching and Logging Exceptions

```php
try {
    $result = $this->process_payment($order);
} catch (WCH_Exception $e) {
    // Option 1: Quick log
    $e->log();  // Logs as ERROR by default

    // Option 2: Log at specific level
    $e->log('critical');

    // Option 3: Return error response
    return $e->to_wp_error();

    // Option 4: Return JSON (for REST API)
    return new WP_REST_Response($e->to_array(), $e->get_http_status());
}
```

### Wrapping External Exceptions

```php
try {
    $api->call();
} catch (Exception $e) {
    throw new WCH_Exception(
        'API call failed: ' . $e->getMessage(),
        'api_error',
        500,
        array(
            'endpoint' => $endpoint,
            'method'   => 'POST',
        ),
        0,
        $e  // Pass original exception as previous
    );
}
```

## Common Error Codes

Use these standardized error codes across the plugin:

```php
// Authentication & Authorization
'invalid_credentials'
'unauthorized_access'
'token_expired'
'insufficient_permissions'

// Data Validation
'invalid_input'
'missing_required_field'
'invalid_format'
'validation_failed'

// Resource Errors
'resource_not_found'
'product_not_found'
'order_not_found'
'customer_not_found'

// Business Logic
'operation_failed'
'payment_failed'
'inventory_insufficient'
'order_cannot_be_modified'

// External Services
'api_error'
'whatsapp_api_error'
'network_error'
'timeout'

// System Errors
'database_error'
'file_system_error'
'configuration_error'
'internal_error'
```

## HTTP Status Codes

Match error codes with appropriate HTTP status:

```php
// Success
200 - OK
201 - Created
204 - No Content

// Client Errors
400 - Bad Request (invalid_input, validation_failed)
401 - Unauthorized (invalid_credentials, token_expired)
403 - Forbidden (insufficient_permissions)
404 - Not Found (resource_not_found, product_not_found)
409 - Conflict (order_cannot_be_modified)
422 - Unprocessable Entity (business_logic_error)
429 - Too Many Requests (rate_limit_exceeded)

// Server Errors
500 - Internal Server Error (internal_error, database_error)
502 - Bad Gateway (api_error)
503 - Service Unavailable (service_unavailable)
504 - Gateway Timeout (timeout)
```

## REST API Integration

```php
class WCH_REST_Controller extends WP_REST_Controller {

    public function create_order($request) {
        try {
            // Validate request
            if (empty($request['items'])) {
                throw new WCH_Exception(
                    'Order items are required',
                    'missing_required_field',
                    400,
                    array('field' => 'items')
                );
            }

            // Create order
            $order = $this->create_wc_order($request);

            // Log success
            WCH_Logger::info('Order created via API', array(
                'order_id'        => $order->get_id(),
                'customer_phone'  => $request['customer_phone'],
                'total'           => $order->get_total(),
            ));

            return new WP_REST_Response(array(
                'success' => true,
                'order_id' => $order->get_id(),
            ), 201);

        } catch (WCH_Exception $e) {
            $e->log();
            return new WP_REST_Response(
                $e->to_array(),
                $e->get_http_status()
            );
        } catch (Exception $e) {
            WCH_Logger::critical('Unexpected error creating order', array(
                'exception' => get_class($e),
                'message'   => $e->getMessage(),
                'trace'     => $e->getTraceAsString(),
            ));

            return new WP_REST_Response(array(
                'success' => false,
                'error'   => 'An unexpected error occurred',
            ), 500);
        }
    }
}
```

## Viewing Logs

### Admin Interface

1. Navigate to **WooCommerce > WCH Logs**
2. Select log file from dropdown
3. Filter by log level if needed
4. View color-coded entries:
   - **Gray**: Debug
   - **Blue**: Info
   - **Yellow**: Warning
   - **Red**: Error
   - **Red/Pink**: Critical

### Manual File Access

```bash
# View today's log
tail -f wp-content/uploads/wch-logs/wch-$(date +%Y-%m-%d).log

# Search for errors
grep "\[ERROR\]" wp-content/uploads/wch-logs/wch-*.log

# Search for specific order
grep "order_id.*12345" wp-content/uploads/wch-logs/wch-*.log

# View last 100 lines
tail -n 100 wp-content/uploads/wch-logs/wch-$(date +%Y-%m-%d).log
```

## Advanced Usage

### Custom Context Processing

```php
class WCH_Order_Manager {

    private function log_order_event($message, $order, $extra = array()) {
        WCH_Logger::info($message, array_merge(array(
            'order_id'        => $order->get_id(),
            'order_status'    => $order->get_status(),
            'customer_id'     => $order->get_customer_id(),
            'total'           => $order->get_total(),
        ), $extra));
    }

    public function process_order($order) {
        $this->log_order_event('Processing order', $order, array(
            'payment_method' => $order->get_payment_method(),
        ));

        // Process...

        $this->log_order_event('Order processed successfully', $order);
    }
}
```

### Request Correlation

All logs within a single request share the same REQUEST_ID:

```php
// Request starts
WCH_Logger::info('Request received');        // [wch_abc123]
WCH_Logger::debug('Validating input');       // [wch_abc123]
WCH_Logger::info('Processing complete');     // [wch_abc123]

// Next request
WCH_Logger::info('Request received');        // [wch_def456]
```

Use REQUEST_ID to trace all operations for a single request.

### Conditional Logging

```php
// Only log in development
if (WP_DEBUG) {
    WCH_Logger::debug('Development info', $data);
}

// Log based on log level setting
if ($this->should_log_verbose()) {
    WCH_Logger::info('Verbose operation details', $details);
}

// Throttled logging
static $log_count = 0;
if ($log_count++ % 100 === 0) {
    WCH_Logger::info('Periodic status update', array('count' => $log_count));
}
```

### Performance Monitoring

```php
public function expensive_operation() {
    $start = microtime(true);

    try {
        // Operation here
        $result = $this->do_work();

        $duration = microtime(true) - $start;
        WCH_Logger::info('Operation completed', array(
            'duration_ms' => round($duration * 1000, 2),
            'result_size' => count($result),
        ));

        return $result;

    } catch (Exception $e) {
        $duration = microtime(true) - $start;
        WCH_Logger::error('Operation failed', array(
            'duration_ms' => round($duration * 1000, 2),
            'exception'   => $e->getMessage(),
        ));
        throw $e;
    }
}
```

## Best Practices

### 1. Log Appropriately

```php
// ✓ Good - actionable information
WCH_Logger::error('Payment gateway returned error', array(
    'gateway'      => 'stripe',
    'error_code'   => $error->code,
    'order_id'     => $order_id,
));

// ✗ Bad - too verbose
WCH_Logger::debug('Variable x is ' . $x);
WCH_Logger::debug('Entering function');
WCH_Logger::debug('Exiting function');
```

### 2. Include Context

```php
// ✓ Good - rich context
WCH_Logger::warning('Low inventory detected', array(
    'product_id'    => $product->get_id(),
    'product_name'  => $product->get_name(),
    'stock_level'   => $stock,
    'threshold'     => $threshold,
));

// ✗ Bad - no context
WCH_Logger::warning('Low inventory');
```

### 3. Use Appropriate Levels

```php
// DEBUG - Development information (WP_DEBUG only)
WCH_Logger::debug('Query results', array('count' => $count));

// INFO - Normal operations
WCH_Logger::info('Order created', array('order_id' => $id));

// WARNING - Recoverable issues
WCH_Logger::warning('API rate limit approaching', array('remaining' => 10));

// ERROR - Operation failed but app continues
WCH_Logger::error('Failed to send notification', array('error' => $msg));

// CRITICAL - Requires immediate attention
WCH_Logger::critical('Database connection lost', array('host' => $host));
```

### 4. Protect Sensitive Data

```php
// ✓ Good - sensitive data automatically redacted
WCH_Logger::info('User login', array(
    'username' => $username,
    'password' => $password,  // Automatically redacted
));

// ✗ Bad - sensitive data in message (not redacted)
WCH_Logger::info("User $username logged in with password $password");

// Solution: Use context array
WCH_Logger::info('User login', array(
    'username' => $username,
    'password' => $password,
));
```

### 5. Handle Exceptions Properly

```php
// ✓ Good - specific exception with context
throw new WCH_Exception(
    'Cannot process order: insufficient inventory',
    'inventory_insufficient',
    422,
    array(
        'product_id'     => $product_id,
        'requested'      => $quantity,
        'available'      => $stock,
    )
);

// ✗ Bad - generic exception
throw new Exception('Error');
```

## Maintenance

### Cleaning Old Logs

```php
// Via admin interface
// WooCommerce > WCH Logs > "Delete Old Logs (30+ days)"

// Programmatically
$deleted = WCH_Logger::delete_old_logs(30);

// Custom retention period
$deleted = WCH_Logger::delete_old_logs(7);  // Keep only 7 days
```

### Monitoring Log Size

```php
$files = WCH_Logger::get_log_files();
$total_size = 0;

foreach ($files as $file) {
    $total_size += $file['size'];
}

if ($total_size > 100 * 1024 * 1024) {  // 100 MB
    WCH_Logger::warning('Log directory size exceeds 100MB', array(
        'total_size' => size_format($total_size),
        'file_count' => count($files),
    ));
}
```

## Troubleshooting

### Issue: Logs not appearing

```php
// Check if logging is working
WCH_Logger::info('Test log entry', array('test' => true));

// Check log directory exists
$files = WCH_Logger::get_log_files();
var_dump($files);

// Check WP_DEBUG for debug logs
if (!defined('WP_DEBUG') || !WP_DEBUG) {
    // Debug logs won't appear
}
```

### Issue: Performance concerns

```php
// Reduce debug logging in production
if (defined('WP_DEBUG') && WP_DEBUG) {
    WCH_Logger::debug('Detailed info', $large_array);
}

// Use throttling for high-frequency logs
static $count = 0;
if (++$count % 100 === 0) {
    WCH_Logger::info('Periodic update', array('count' => $count));
}
```

### Issue: Disk space

```bash
# Check log directory size
du -sh wp-content/uploads/wch-logs/

# Reduce retention period
# In admin: WooCommerce > WCH Logs > Delete Old Logs
# Or programmatically:
WCH_Logger::delete_old_logs(7);  // Keep only 7 days
```
