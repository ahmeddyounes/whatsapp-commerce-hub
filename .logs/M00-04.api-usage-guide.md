# WhatsApp Commerce Hub REST API Usage Guide

## Overview

The WCH REST API provides endpoints for admin operations and external integrations. All endpoints are accessible under the `wch/v1` namespace.

## Base URL

```
https://your-site.com/wp-json/wch/v1/
```

## Authentication

### Admin Endpoints

Admin endpoints require one of the following:

1. **WordPress Authentication** (for logged-in users with `manage_woocommerce` capability)
2. **API Key Authentication** (via `X-WCH-API-Key` header)

Example with API Key:
```bash
curl -X GET https://your-site.com/wp-json/wch/v1/settings \
  -H "X-WCH-API-Key: your-api-key-here"
```

### Webhook Endpoint

The webhook endpoint requires signature verification:

```bash
curl -X POST https://your-site.com/wp-json/wch/v1/webhook \
  -H "X-Hub-Signature-256: sha256=..." \
  -H "Content-Type: application/json" \
  -d '{"object":"whatsapp_business_account",...}'
```

## Rate Limits

- **Admin endpoints**: 100 requests per minute
- **Webhook endpoint**: 1000 requests per minute

When rate limit is exceeded, you'll receive a `429 Too Many Requests` response:

```json
{
  "code": "wch_rest_rate_limit_exceeded",
  "message": "Rate limit exceeded. Maximum 100 requests per minute allowed.",
  "data": {
    "status": 429
  }
}
```

## Endpoints

### API Discovery

**GET** `/wch/v1/`

Returns API information and available endpoints.

**Response:**
```json
{
  "name": "WhatsApp Commerce Hub API",
  "version": "v1",
  "namespace": "wch/v1",
  "description": "REST API for WhatsApp Commerce Hub admin and external integrations.",
  "endpoints": {
    "/settings": "Settings management (GET/POST)",
    "/conversations": "List conversations (GET/POST)",
    ...
  },
  "authentication": {
    "admin": "WordPress authentication or X-WCH-API-Key header",
    "webhook": "X-Hub-Signature-256 header"
  }
}
```

### Settings (Planned)

**GET** `/wch/v1/settings` - Get current settings
**POST** `/wch/v1/settings` - Update settings

### Conversations (Planned)

**GET** `/wch/v1/conversations` - List conversations
**POST** `/wch/v1/conversations` - Create conversation
**GET** `/wch/v1/conversations/{id}` - Get single conversation
**PATCH** `/wch/v1/conversations/{id}` - Update conversation
**GET** `/wch/v1/conversations/{id}/messages` - Get conversation messages
**POST** `/wch/v1/conversations/{id}/messages` - Send message

### Customers (Planned)

**GET** `/wch/v1/customers` - List customers
**GET** `/wch/v1/customers/{phone}` - Get customer by phone
**PATCH** `/wch/v1/customers/{phone}` - Update customer

### Analytics (Planned)

**GET** `/wch/v1/analytics` - Get analytics data

### Broadcasts (Planned)

**GET** `/wch/v1/broadcasts` - List broadcast campaigns
**POST** `/wch/v1/broadcasts` - Create broadcast
**GET** `/wch/v1/broadcasts/{id}` - Get single broadcast
**PATCH** `/wch/v1/broadcasts/{id}` - Update broadcast
**DELETE** `/wch/v1/broadcasts/{id}` - Delete broadcast

### Webhook (Planned)

**POST** `/wch/v1/webhook` - WhatsApp webhook callback

## Response Format

### Success Response

```json
{
  "data": {
    "id": 123,
    "field": "value"
  }
}
```

### Error Response

All errors follow this format:

```json
{
  "code": "error_code",
  "message": "Human-readable error message",
  "data": {
    "status": 400
  }
}
```

### Pagination

List endpoints include pagination headers:

- `X-WP-Total`: Total number of items
- `X-WP-TotalPages`: Total number of pages
- `Link`: Pagination links (prev/next)

Example:
```
X-WP-Total: 100
X-WP-TotalPages: 10
Link: <https://your-site.com/wp-json/wch/v1/conversations?page=2>; rel="next"
```

## Error Codes

| Code | Status | Description |
|------|--------|-------------|
| `wch_rest_forbidden` | 403 | Missing required permissions |
| `wch_rest_missing_api_key` | 401 | API key not provided |
| `wch_rest_invalid_api_key` | 401 | Invalid API key |
| `wch_rest_api_key_not_configured` | 500 | API key authentication not set up |
| `wch_rest_missing_signature` | 401 | Webhook signature not provided |
| `wch_rest_invalid_signature` | 401 | Invalid webhook signature |
| `wch_rest_webhook_not_configured` | 500 | Webhook authentication not set up |
| `wch_rest_rate_limit_exceeded` | 429 | Rate limit exceeded |
| `wch_rest_invalid_phone` | 400 | Invalid phone number format |

## Phone Number Format

All phone numbers must be in E.164 format: `+[country code][number]`

Examples:
- `+1234567890` (valid)
- `+441234567890` (valid)

The API will automatically sanitize phone numbers:
- `(123) 456-7890` → `+1234567890`
- `123-456-7890` → `+1234567890`

## CORS

The API includes CORS headers to allow cross-origin requests:

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization, X-WCH-API-Key, X-Hub-Signature-256
```

## Configuration

### Setting Up API Key

1. Generate a secure API key (32+ characters recommended)
2. Store the hashed key in settings:

```php
$settings = WCH_Settings::getInstance();
$api_key = 'your-secure-api-key';
$settings->set('api.api_key_hash', wp_hash_password($api_key));
```

3. Provide the plain API key to clients (store securely, do not log)

### Setting Up Webhook Secret

1. Generate a secure webhook secret
2. Store it encrypted in settings:

```php
$settings = WCH_Settings::getInstance();
$settings->set('api.webhook_secret', 'your-webhook-secret');
```

3. Configure the same secret in WhatsApp Business API dashboard

## OpenAPI/Swagger Compatibility

The API follows OpenAPI 3.0 conventions:

- RESTful URL structure
- Standard HTTP methods
- Standard HTTP status codes
- JSON request/response format
- Clear error messages with codes

A full OpenAPI specification can be generated from the endpoint schemas.

## Next Steps

To implement concrete endpoints:

1. Create controller class extending `WCH_REST_Controller`
2. Implement `register_routes()` method
3. Implement `get_item_schema()` method
4. Add controller to the filter:

```php
add_filter('wch_rest_api_controllers', function($controllers) {
    $controllers[] = 'WCH_Settings_Controller';
    return $controllers;
});
```

Example controller structure:

```php
class WCH_Settings_Controller extends WCH_REST_Controller {
    protected $rest_base = 'settings';

    public function register_routes() {
        register_rest_route($this->namespace, '/' . $this->rest_base, array(
            array(
                'methods'             => WP_REST_Server::READABLE,
                'callback'            => array($this, 'get_items'),
                'permission_callback' => array($this, 'check_admin_permission'),
            ),
            array(
                'methods'             => WP_REST_Server::CREATABLE,
                'callback'            => array($this, 'create_item'),
                'permission_callback' => array($this, 'check_admin_permission'),
            ),
        ));
    }

    public function get_item_schema() {
        return array(
            '$schema'    => 'http://json-schema.org/draft-04/schema#',
            'title'      => 'settings',
            'type'       => 'object',
            'properties' => array(
                'section' => array(
                    'description' => 'Settings section',
                    'type'        => 'string',
                ),
            ),
        );
    }
}
```
