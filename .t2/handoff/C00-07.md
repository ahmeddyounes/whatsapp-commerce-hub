# Handoff: C00-07

Created: 2026-01-18T10:19:31.317023Z

Spec: .plans/C00-07.md


## 2026-01-18T10:22:34.839272Z — claude — impl

Command:
```
claude -p --output-format json --model sonnet --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C00-07 in this git repository.

1) Read the spec: .plans/C00-07.md
2) Read handoff/context: .t2/handoff/C00-07.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 6dfbfc85-7258-4f71-939f-64eb76f0cd89

Agent final message (file: C00-07.claude.impl.last.md):

Perfect! The LegacySettingsAdapter maps the old flat keys to the new sectioned keys. The key mappings show:
- `phone_number_id` → `api.whatsapp_phone_number_id`
- `access_token` → `api.access_token`
- `openai_api_key` → `ai.openai_api_key`

This is exactly what we've implemented in the ApiClientServiceProvider. Now let me write a summary of the changes and verify everything is correct:

## Summary

I have successfully implemented task C00-07. Here's what was changed:

**Status: DONE**

### Summary of Changes

Updated `includes/Providers/ApiClientServiceProvider.php` to use `SettingsInterface` with sectioned keys instead of the deprecated flat `wch.settings` array:

1. **Added SettingsInterface import** (line 21)

2. **Updated WhatsAppClientInterface binding** (lines 45-66):
   - Now uses `SettingsInterface::class` instead of `'wch.settings'`
   - Reads credentials using sectioned keys: `api.whatsapp_phone_number_id` and `api.access_token`
   - Clear error message when credentials are not configured: "WhatsApp API credentials not configured. Set api.whatsapp_phone_number_id and api.access_token in settings."
   - Removed deprecated comments about future migration

3. **Updated OpenAIClientInterface binding** (lines 74-93):
   - Now uses `SettingsInterface::class` instead of `'wch.settings'`
   - Reads API key using sectioned key: `ai.openai_api_key`
   - Clear error message when API key is not configured: "OpenAI API key not configured. Set ai.openai_api_key in settings."
   - Removed deprecated comments

4. **Updated wch.whatsapp.sender service** (lines 214-371):
   - Updated constructor to accept `SettingsInterface` type hint (line 228)
   - Updated send method to use sectioned keys: `api.whatsapp_phone_number_id` and `api.access_token`
   - Clear error message for misconfiguration

5. **Removed deprecated service bindings**:
   - Removed `wch.whatsapp.client` binding that swallowed exceptions
   - Removed `wch.openai.client` binding that swallowed exceptions
   - Updated `provides()` method to remove these deprecated IDs

6. **All legacy comments removed** - no more references to deprecated `wch.settings` or future migration plans

### How to Verify

The implementation follows the spec's acceptance criteria:
- WhatsApp/OpenAI clients now fail fast with clear errors when not configured
- No mismatched key usage remains
- All settings access uses the sectioned key format (`api.*`, `ai.*`)

**Manual verification commands:**
```bash
# Check PHP syntax
php -l includes/Providers/ApiClientServiceProvider.php

# Verify no legacy wch.settings usage remains
grep -r "wch\.settings" includes/Providers/ApiClientServiceProvider.php

# Verify sectioned keys are used
grep -E "(api\.(whatsapp_phone_number_id|access_token)|ai\.openai_api_key)" includes/Providers/ApiClientServiceProvider.php
```

**Runtime verification:**
- When WhatsApp credentials are not set, attempting to resolve `WhatsAppClientInterface` will throw: `RuntimeException: WhatsApp API credentials not configured. Set api.whatsapp_phone_number_id and api.access_token in settings.`
- When OpenAI API key is not set, attempting to resolve `OpenAIClientInterface` will throw: `RuntimeException: OpenAI API key not configured. Set ai.openai_api_key in settings.`

### Risks / Follow-ups

**No breaking changes:**
- The `LegacySettingsAdapter` already maps old flat keys to new sectioned keys
- Tests use direct client instantiation, not the service provider
- No code was found using the removed `wch.whatsapp.client` or `wch.openai.client` service IDs

**Follow-up considerations:**
- Monitor for any runtime issues when the plugin tries to instantiate these clients
- The error messages now clearly indicate which settings keys need to be set, making configuration issues easier to debug


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M includes/Providers/ApiClientServiceProvider.php
?? .logs/C00-06.gitcommit.txt
?? .logs/C00-07.claude.impl.last.md
?? .logs/C00-07.claude.impl.raw.txt
?? .plans/C00-07.md
?? .t2/handoff/C00-07.md

diff --stat:
.t2/state.json                                  |  5 ++-
 includes/Providers/ApiClientServiceProvider.php | 60 +++++++------------------
 2 files changed, 18 insertions(+), 47 deletions(-)

```
