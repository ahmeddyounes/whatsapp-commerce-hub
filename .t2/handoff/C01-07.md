# Handoff: C01-07

Created: 2026-01-18T11:44:08.548291Z

Spec: .plans/C01-07.md


## 2026-01-18T11:53:20.167144Z — claude — impl

Command:
```
claude -p --output-format json --model sonnet --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C01-07 in this git repository.

1) Read the spec: .plans/C01-07.md
2) Read handoff/context: .t2/handoff/C01-07.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: 
- test: 

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: bc9269e5-bcb7-4f14-983b-04a15bf0732f

Agent final message (file: C01-07.claude.impl.last.md):

Excellent! Now let me create a comprehensive summary of the implementation:

---

## Status: DONE

## Summary of Changes

### 1. Core Exception Taxonomy (New Files)
Created three base exception classes to form a minimal but effective taxonomy:

- **`includes/Exceptions/DomainException.php`** - Business rule violations (NEVER retried)
  - Default HTTP 400, includes `isRetryable()` returning false
  - Examples: Cart expired, out of stock, invalid coupon

- **`includes/Exceptions/ApplicationException.php`** - Application layer errors (MAY be retried)
  - Default HTTP 500, subclasses override `isRetryable()` for specific logic
  - Examples: Validation errors, state conflicts, workflow issues

- **`includes/Exceptions/InfrastructureException.php`** - External service failures (SHOULD be retried)
  - Default HTTP 503, includes `isRetryable()` returning true
  - Examples: API timeouts, database failures, network errors

### 2. Base Exception Enhancement
Updated **`includes/Exceptions/WchException.php`**:
- Added `isRetryable(): bool` method (returns false by default for safety)
- All taxonomy exceptions inherit this method and override as needed

### 3. Existing Exception Refactoring
Migrated existing exceptions to extend appropriate taxonomy base:

- **`includes/Exceptions/ValidationException.php`** → extends `ApplicationException`
  - Added `isRetryable()` returning false (validation never retried)
  
- **`includes/Exceptions/CartException.php`** → extends `DomainException`
  - Cart errors are business rule violations (not retryable)
  
- **`includes/Domain/Cart/CartException.php`** → extends `DomainException`
  - Legacy cart exception also updated for consistency

- **`includes/Exceptions/ApiException.php`** → extends `InfrastructureException`
  - Enhanced `isRetryable()` logic:
    - Auth errors (190, 200, 10, 100) → NOT retryable
    - Rate limits (4, 17, 32, 613) → retryable
    - 5xx errors → retryable
    - Recipient errors (131000-131999) → NOT retryable
    - 4xx errors → NOT retryable

### 4. Circuit Breaker Integration
Updated **`includes/Resilience/CircuitBreaker.php`**:
- **`CircuitOpenException`** now extends `InfrastructureException`
- Updated constructor signature to take service name and context
- Updated throw statements to use new constructor (2 locations)

### 5. Queue Processor Retry Logic
Updated **`includes/Queue/Processors/AbstractQueueProcessor.php`**:
- Enhanced `shouldRetry()` method to use exception taxonomy
- Priority-based decision tree:
  1. `DomainException` → NEVER retry
  2. `ApplicationException` → Check `isRetryable()`
  3. `InfrastructureException` → Check `isRetryable()`
  4. `WchException` → Check `isRetryable()`
  5. Standard PHP exceptions → Existing logic (no retry for InvalidArgumentException/DomainException)
- Added use statements for all taxonomy classes

### 6. Service Layer Updates
Updated **`includes/Application/Services/OrderSyncService.php`**:
- Converted `RuntimeException` → `InfrastructureException` for WooCommerce unavailable (retryable)
- Converted `RuntimeException` → `ApplicationException` for order creation failures (not retryable by default)
- Added proper error codes and context to all exceptions

### 7. Documentation
Created **`docs/exception-taxonomy.md`**:
- Complete taxonomy overview and architecture
- Detailed guide for each exception type with examples
- Retry decision matrix
- Implementation guide with DO/DON'T examples
- Migration guide from standard exceptions
- Benefits and related files

## How to Verify

### 1. Syntax Check (Already Passed)
```bash
php -l includes/Exceptions/*.php
php -l includes/Queue/Processors/AbstractQueueProcessor.php
php -l includes/Resilience/CircuitBreaker.php
php -l includes/Application/Services/OrderSyncService.php
```

### 2. Verify Exception Hierarchy
```bash
# Check that new exceptions extend proper base
grep -n "extends" includes/Exceptions/DomainException.php
grep -n "extends" includes/Exceptions/ApplicationException.php
grep -n "extends" includes/Exceptions/InfrastructureException.php
```

### 3. Test Retry Logic (Manual)
- Create a test job that throws `DomainException` → should NOT retry, goes to DLQ
- Create a test job that throws `InfrastructureException` → should retry 3 times
- Create a test job that throws `ValidationException` → should NOT retry, goes to DLQ
- Create a test job that throws `ApiException` with rate limit → should retry
- Create a test job that throws `ApiException` with auth error → should NOT retry

### 4. Verify Documentation
```bash
cat docs/exception-taxonomy.md
```

### 5. Integration Test
Test in WordPress environment:
1. Trigger webhook message processing with invalid data → ValidationException → DLQ
2. Simulate WhatsApp API rate limit → ApiException → Retry
3. Simulate cart out of stock → CartException (Domain) → DLQ
4. Simulate WooCommerce unavailable → InfrastructureException → Retry

## Risks / Follow-ups

### Risks (Low)
1. **Backward Compatibility**: Existing code catching `WchException` will still work, but code catching `RuntimeException` may not catch new Infrastructure exceptions
   - **Mitigation**: Most exception handling is in AbstractQueueProcessor which now handles all types

2. **CircuitOpenException Constructor Change**: Code that throws CircuitOpenException needs to use new signature
   - **Mitigation**: Only 2 locations updated, both in CircuitBreaker.php

3. **Missing Conversions**: Some RuntimeException instances not yet converted
   - **Mitigation**: Old code still works, can be migrated incrementally

### Follow-ups (Recommended)
1. **Audit remaining RuntimeException usage**: Convert more service layer exceptions to taxonomy
   - Priority files: `WhatsAppApiClient.php` (many RuntimeException instances)
   - Priority files: Other service classes in `includes/Application/Services/`

2. **Add unit tests**: Test retry logic with different exception types
   - Test `AbstractQueueProcessor::shouldRetry()` with each taxonomy type
   - Test `ApiException::isRetryable()` with various error codes

3. **Observability improvements**: Add metrics for exception types in DLQ
   - Track DLQ reasons by exception taxonomy
   - Alert on high DomainException rates (business logic issues)
   - Alert on high InfrastructureException rates (service issues)

4. **Custom DLQ Reasons**: Update DLQ to use taxonomy-based reasons
   - Add `REASON_DOMAIN_ERROR`, `REASON_VALIDATION`, `REASON_INFRASTRUCTURE`
   - Makes DLQ analysis more meaningful

5. **Developer Training**: Ensure team understands when to use each exception type
   - Review exception-taxonomy.md with team
   - Code review checklist for exception usage

### Optional Enhancements
1. Create specific exception types for common scenarios:
   - `PaymentException extends DomainException`
   - `NetworkException extends InfrastructureException`
   - `StateConflictException extends ApplicationException`

2. Add exception middleware for automatic logging/metrics based on type

3. Create exception factory utilities for common patterns

## Files Changed
```
Modified:
  includes/Exceptions/WchException.php
  includes/Exceptions/ValidationException.php
  includes/Exceptions/CartException.php
  includes/Exceptions/ApiException.php
  includes/Domain/Cart/CartException.php
  includes/Queue/Processors/AbstractQueueProcessor.php
  includes/Resilience/CircuitBreaker.php
  includes/Application/Services/OrderSyncService.php

Created:
  includes/Exceptions/DomainException.php
  includes/Exceptions/ApplicationException.php
  includes/Exceptions/InfrastructureException.php
  docs/exception-taxonomy.md
```


Repo snapshot:
```
branch: main

status:
M .t2/state.json
 M includes/Application/Services/OrderSyncService.php
 M includes/Domain/Cart/CartException.php
 M includes/Exceptions/ApiException.php
 M includes/Exceptions/CartException.php
 M includes/Exceptions/ValidationException.php
 M includes/Exceptions/WchException.php
 M includes/Queue/Processors/AbstractQueueProcessor.php
 M includes/Resilience/CircuitBreaker.php
?? .logs/C01-06.gitcommit.txt
?? .logs/C01-07.claude.impl.last.md
?? .logs/C01-07.claude.impl.raw.txt
?? .plans/C01-07.md
?? .t2/handoff/C01-07.md
?? docs/exception-taxonomy.md
?? includes/Exceptions/ApplicationException.php
?? includes/Exceptions/DomainException.php
?? includes/Exceptions/InfrastructureException.php

diff --stat:
.t2/state.json                                     |  5 ++--
 includes/Application/Services/OrderSyncService.php | 22 ++++++++++++--
 includes/Domain/Cart/CartException.php             |  8 +++--
 includes/Exceptions/ApiException.php               | 28 ++++++++++++++++--
 includes/Exceptions/CartException.php              |  6 +++-
 includes/Exceptions/ValidationException.php        | 13 ++++++++-
 includes/Exceptions/WchException.php               | 12 ++++++++
 .../Queue/Processors/AbstractQueueProcessor.php    | 34 +++++++++++++++++++++-
 includes/Resilience/CircuitBreaker.php             | 29 ++++++++++++++----
 9 files changed, 139 insertions(+), 18 deletions(-)

```
