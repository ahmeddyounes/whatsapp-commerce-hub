# M03-02 â€” Conversation Context Manager

Create context management for multi-turn conversations. Create class WCH_Context_Manager. Method get_context($conversation_id): Load from wch_conversations.context JSON column, return WCH_Conversation_Context object or new instance if null. Method save_context($conversation_id, $context): Serialize and save to database, update last_activity timestamp. Method clear_context($conversation_id): Reset to initial state, preserve customer linkage. WCH_Conversation_Context properties and methods: state (current FSM state), state_data (associative array), history (array of last 10 message pairs), slots (extracted entity values like product_name, quantity, address), customer_phone, started_at, expires_at. Slot management: set_slot($name, $value), get_slot($name, $default), has_slot($name), clear_slot($name), get_all_slots(). History management: add_exchange($user_message, $bot_response), get_history(), get_last_exchange(). Method build_ai_context(): Return formatted string for AI prompts including: business name, current state, filled slots, recent history, available actions. Implement context expiration: If last_activity older than 24 hours, archive conversation and start fresh. Create method merge_contexts($old_context, $new_data): Intelligently merge returning customer context with new session. Store frequently accessed contexts in object cache for performance. Acceptance criteria: Context persists across messages, slots retain values through conversation, history properly truncated, AI context well-formatted, expired contexts handled.
