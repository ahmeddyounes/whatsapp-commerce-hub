# M03-05 â€” AI Conversation Assistant Integration

Create OpenAI integration for enhanced conversation handling. Create class WCH_AI_Assistant. Constructor accepts config: api_key, model, temperature, max_tokens, system_prompt. Method generate_response($user_message, $context): Build prompt, call API, parse response, return text and any extracted actions. Build system prompt dynamically including: Business identity and tone guidelines, available products summary (top categories, current promotions), current conversation state and context, customer profile if known, specific instructions based on state (e.g., 'Help customer choose a product' in BROWSING state). Use function calling for structured outputs. Define functions: suggest_products(query, limit), get_product_details(product_id), add_to_cart(product_id, quantity), apply_coupon(code), escalate_to_human(reason). Method process_function_call($function_name, $arguments): Execute the corresponding WCH action and return result to AI for final response. Rate limiting: Max 10 AI calls per conversation per hour, fallback to rule-based responses if exceeded. Cost tracking: Log token usage per conversation, calculate estimated cost, set monthly budget cap in settings with alerts at 80% and 100%. Error handling: Timeout after 15 seconds, retry once on 5xx errors, graceful degradation message on failure. Content filtering: Validate AI responses don't contain inappropriate content before sending. Acceptance criteria: AI responses contextually appropriate, function calls execute correctly, rate limits enforced, costs tracked, failures handled gracefully.
