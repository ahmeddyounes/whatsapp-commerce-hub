# M04-02 â€” Shopping Cart Manager

Create cart management functionality. Create class WCH_Cart_Manager. Cart stored in wch_carts table, keyed by customer_phone. Cart item structure: {product_id, variation_id (nullable), quantity, price_at_add, product_name, variant_attributes}. Method get_cart($phone): Return cart array or empty cart with expiry set to 72 hours from now. Method add_item($phone, $product_id, $variation_id, $quantity): Validate product exists and in stock, check quantity against stock, if item already in cart then increment quantity else add new item, update cart expiry, return updated cart. Throw WCH_Cart_Exception if validation fails with specific reason. Method update_quantity($phone, $item_index, $new_quantity): Validate stock, update quantity, recalculate totals, return updated cart. Remove item if quantity is 0. Method remove_item($phone, $item_index): Remove item from cart, return updated cart. Method clear_cart($phone): Empty cart items but retain customer association. Method apply_coupon($phone, $coupon_code): Validate WC coupon using WC_Coupon class, check restrictions (min total, product restrictions, usage limits), store coupon_code in cart, return discount amount or throw exception with reason. Method remove_coupon($phone): Clear coupon from cart. Method calculate_totals($cart): Return {subtotal, discount, tax, shipping_estimate, total} using WC tax and shipping calculation. Method get_cart_summary_message($phone): Build formatted text summary: itemized list with quantities and line totals, subtotal, discount if coupon applied, estimated shipping, total. Method check_cart_validity($phone): Verify all items still exist, in stock, prices unchanged. Mark items with issues and return validation result. Abandoned cart detection: Flag carts not converted within configured hours. Acceptance criteria: Cart CRUD operations work atomically, coupons validate correctly, totals match WC calculations, expired carts cleaned up, abandoned carts detected.
