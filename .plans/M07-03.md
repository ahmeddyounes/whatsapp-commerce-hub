# M07-03 â€” End-to-End Conversation Flow Tests

Create E2E tests for complete customer journeys. Create test class WCH_E2E_Conversation_Test extending WCH_Integration_Test_Case. Test scenarios to implement: test_complete_purchase_flow(): Simulate customer greeting -> browse category -> view product -> add to cart -> checkout with address -> select shipping -> select payment -> confirm order. Assert: All messages sent correctly, Cart created and modified properly, Order created in WooCommerce, Confirmation notification sent, Conversation state progresses correctly. test_cart_modification_flow(): Add product A -> Add product B -> Update quantity A -> Remove B -> Apply coupon -> View cart. Assert: Cart reflects all changes, Totals calculated correctly, Coupon validated and applied. test_returning_customer_flow(): Customer with saved address and order history, Quick reorder of previous product, Address selection from saved addresses. Assert: Customer recognized, History accessible, Checkout faster. test_abandoned_cart_recovery(): Add items -> Inactivity timeout -> Recovery message sent -> Customer returns -> Completes purchase. Assert: Cart preserved, Recovery attributed, Conversion tracked. test_human_handoff_flow(): Customer frustrated (detects sentiment or explicit request), Bot escalates to human, Human agent takes over, Conversation resolved. Assert: Escalation triggered, Agent notified, Context preserved. test_multi_language_flow(): Customer sends Hindi/Portuguese message, Bot responds in detected language, Flow completes in customer language. Assert: Language detected, Responses translated, Templates use correct language. test_error_recovery_flow(): Product goes out of stock during checkout, Payment fails, Network timeout during message send. Assert: Customer informed gracefully, Recovery options provided, No data corruption. Helper methods: simulate_webhook($message_data) - trigger webhook handler, assert_message_sent($expected_type, $expected_content), get_conversation_state($phone), advance_time($hours) for timeout testing. Acceptance criteria: All critical paths have E2E coverage, tests run in <5 minutes, failures indicate exact step that failed, tests are deterministic.
