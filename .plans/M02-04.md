# M02-04 â€” Customer Data Mapper & Profile Service

Create customer profile management linking WhatsApp users to WooCommerce customers. Create class WCH_Customer_Service. Method get_or_create_profile($phone): Normalize phone to E.164, check wch_customer_profiles table, create if not exists, return WCH_Customer_Profile object. Method link_to_wc_customer($phone, $wc_customer_id): Associate WhatsApp profile with WooCommerce customer, merge order history. Method find_wc_customer_by_phone($phone): Search WC customers by billing_phone meta (with format variations +1xxx, 1xxx, xxx), return customer_id or null. WCH_Customer_Profile class properties: phone, wc_customer_id (nullable), name, saved_addresses (array), order_history (from WC if linked), preferences (language, currency), opt_in_marketing, lifetime_value (calculated), last_order_date, total_orders. Method save_address($phone, $address_data, $is_default): Validate address fields, store in saved_addresses JSON, mark as default if specified. Method get_default_address($phone): Return default saved address or null. Method update_preferences($phone, $preferences): Merge and save preference updates. Method get_order_history($phone): If linked to WC customer, fetch orders, else fetch orders with matching billing_phone. Method calculate_customer_stats($phone): Return total_orders, total_spent, average_order_value, days_since_last_order. Privacy methods: export_customer_data($phone) for GDPR export, delete_customer_data($phone) for GDPR erasure - anonymize conversations, delete profile. Acceptance criteria: Profiles persist across conversations, WC linking works with phone variations, addresses save and retrieve correctly, GDPR methods complete, customer stats accurate.
