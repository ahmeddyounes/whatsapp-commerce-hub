# M04-03 â€” Checkout Flow Controller

Create multi-step checkout process within WhatsApp. Create class WCH_Checkout_Controller. Checkout steps: ADDRESS, SHIPPING_METHOD, PAYMENT_METHOD, REVIEW, CONFIRM. Method start_checkout($conversation): Validate cart not empty, check_cart_validity(), transition to CHECKOUT_ADDRESS state, call request_address(). Method request_address($conversation): If customer has saved addresses, send list message to select existing or enter new. Otherwise prompt for address entry with format instructions. Method process_address_input($conversation, $input): If list selection, load saved address. If text, parse address using WCH_Address_Parser (extract name, street, city, state, postal, country). Validate address completeness, store in checkout context, request shipping method. Method show_shipping_methods($conversation): Calculate available WC shipping methods for address and cart, send list with shipping options showing name and cost, store selection in context. Method show_payment_methods($conversation): Based on settings and region, send list of enabled payment methods: COD, UPI (India), PIX (Brazil), Card (Stripe/PayPal link), WhatsApp Pay (if available). Each option shows any additional fees. Method process_payment_selection($conversation, $method): Store selection, calculate final totals including payment fees, show order review. Method show_order_review($conversation): Send detailed summary message: items, shipping address, shipping method + cost, payment method + any fees, total. Include Edit buttons for each section and Confirm Order button. Method confirm_order($conversation): Final stock check, create WC order via WCH_Order_Sync_Service, process payment if applicable, clear cart, send confirmation with order number. Handle errors: Out of stock during checkout sends notification and returns to cart. Payment failure shows retry option. Acceptance criteria: Checkout progresses through all steps, address parsing works, shipping calculated correctly, payment methods work, order created successfully, edge cases handled.
