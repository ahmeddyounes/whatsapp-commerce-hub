# M00-02 â€” Database Schema & Migration System

Create database migration system and initial schema. Create class WCH_Database_Manager with methods: install(), uninstall(), get_table_name($table), run_migrations(). Use dbDelta() for table creation. Tables to create: wch_conversations (id BIGINT AUTO_INCREMENT, customer_phone VARCHAR(20) INDEX, wa_conversation_id VARCHAR(100), status ENUM pending/active/closed, assigned_agent_id BIGINT NULL, context JSON, last_message_at DATETIME, created_at DATETIME, updated_at DATETIME). wch_messages (id BIGINT AUTO_INCREMENT, conversation_id BIGINT FOREIGN KEY, direction ENUM inbound/outbound, message_type ENUM text/interactive/image/document/template, wa_message_id VARCHAR(100) UNIQUE, content JSON, status ENUM sent/delivered/read/failed, created_at DATETIME INDEX). wch_carts (id BIGINT AUTO_INCREMENT, customer_phone VARCHAR(20) UNIQUE, items JSON, coupon_code VARCHAR(50) NULL, shipping_address JSON NULL, expires_at DATETIME INDEX, created_at DATETIME, updated_at DATETIME). wch_customer_profiles (id BIGINT AUTO_INCREMENT, phone VARCHAR(20) UNIQUE, wc_customer_id BIGINT NULL INDEX, name VARCHAR(100), saved_addresses JSON, preferences JSON, opt_in_marketing TINYINT DEFAULT 0, created_at DATETIME, updated_at DATETIME). wch_broadcast_campaigns (id BIGINT AUTO_INCREMENT, name VARCHAR(200), template_name VARCHAR(100), audience_filter JSON, status ENUM draft/scheduled/sending/completed/failed, scheduled_at DATETIME NULL, sent_count INT DEFAULT 0, delivered_count INT DEFAULT 0, read_count INT DEFAULT 0, created_at DATETIME, updated_at DATETIME). wch_sync_queue (id BIGINT AUTO_INCREMENT, entity_type ENUM product/order/inventory, entity_id BIGINT, action ENUM create/update/delete, status ENUM pending/processing/completed/failed, attempts INT DEFAULT 0, error_message TEXT NULL, created_at DATETIME INDEX, processed_at DATETIME NULL). Store schema version in wp_options as 'wch_db_version'. Run migrations on plugin activation and admin_init if version mismatch. Acceptance criteria: All tables created with proper indexes and foreign keys, migrations are idempotent, uninstall removes all tables when 'WCH_REMOVE_DATA' constant is true.
