# M01-02 â€” WhatsApp Webhook Handler

Create secure webhook endpoint for receiving WhatsApp events. Create class WCH_Webhook_Handler. Register REST route POST /wch/v1/webhook and GET /wch/v1/webhook (for verification). Implement webhook verification for GET: return hub.challenge if hub.verify_token matches stored token, else 403. For POST requests: Validate X-Hub-Signature-256 header using hash_hmac('sha256', payload, app_secret) - return 401 if invalid. Parse webhook payload and dispatch to appropriate handlers. Webhook event types to handle: 'messages' - new incoming message, 'statuses' - message status update (sent/delivered/read/failed), 'errors' - delivery errors. Create event dispatcher method dispatch_event($type, $data) using do_action('wch_webhook_{$type}', $data). For messages event, extract: from (phone), timestamp, type (text/interactive/image/document/button/location), message content based on type, context (replied message id if reply). For statuses event, extract: message_id, status, timestamp, recipient_id, errors array if failed. Store raw webhook payload in wch_messages table for debugging. Implement idempotency: check if message_id already processed using transient 'wch_msg_{id}' (1 hour TTL). Return 200 OK immediately after validation, process asynchronously using WCH_Queue. Acceptance criteria: Webhook verification works on Meta setup, signature validation rejects tampered requests, duplicate messages ignored, all event types parsed correctly, processing is async.
