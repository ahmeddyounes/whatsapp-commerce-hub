# M03-01 â€” Conversation State Machine

Create finite state machine for managing conversation flows. Create class WCH_Conversation_FSM. States enum: IDLE, BROWSING, VIEWING_PRODUCT, CART_MANAGEMENT, CHECKOUT_ADDRESS, CHECKOUT_PAYMENT, CHECKOUT_CONFIRM, AWAITING_HUMAN, COMPLETED. Events enum: START, SELECT_CATEGORY, SEARCH, VIEW_PRODUCT, ADD_TO_CART, VIEW_CART, MODIFY_CART, START_CHECKOUT, ENTER_ADDRESS, SELECT_PAYMENT, CONFIRM_ORDER, REQUEST_HUMAN, AGENT_TAKEOVER, TIMEOUT, RESET. Define transitions array: {from_state, event, to_state, guard_condition, action}. Example transitions: (IDLE, START, BROWSING, null, show_main_menu), (BROWSING, VIEW_PRODUCT, VIEWING_PRODUCT, product_exists, show_product_details), (VIEWING_PRODUCT, ADD_TO_CART, CART_MANAGEMENT, has_stock, add_item_and_show_cart), (CART_MANAGEMENT, START_CHECKOUT, CHECKOUT_ADDRESS, cart_not_empty, request_address). Method transition($conversation, $event, $payload): Get current state, find valid transition, check guard condition, execute action, update state, persist to database, log transition. Method get_available_events($conversation): Return valid events from current state. Create WCH_Conversation_Context class storing: current_state, state_data (temporary data like selected_product_id), conversation_history (last 10 exchanges), started_at, last_activity_at. Timeout handling: After 30 min inactivity, transition to IDLE with cart preserved. Save context on every state change. Add filter 'wch_fsm_transitions' to allow adding custom states/transitions. Acceptance criteria: State transitions enforce valid flows, invalid events rejected gracefully, context persists correctly, timeouts handled, extensible via filters.
