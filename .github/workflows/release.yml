name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, json, curl, openssl
          coverage: none

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --no-dev --optimize-autoloader --prefer-dist --no-interaction

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Verify version matches plugin file
        run: |
          PLUGIN_VERSION=$(grep "Version:" whatsapp-commerce-hub.php | awk '{print $3}')
          TAG_VERSION=${{ steps.get_version.outputs.VERSION }}
          if [ "$PLUGIN_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Plugin version ($PLUGIN_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi

      - name: Build production ZIP
        run: |
          # Create build directory
          mkdir -p build/whatsapp-commerce-hub

          # Copy plugin files
          rsync -av --exclude-from=.distignore \
            --exclude='.git*' \
            --exclude='.github' \
            --exclude='tests' \
            --exclude='bin' \
            --exclude='node_modules' \
            --exclude='.wordpress-org' \
            --exclude='phpunit.xml.dist' \
            --exclude='phpcs.xml.dist' \
            --exclude='phpstan.neon' \
            --exclude='phpstan-baseline.neon' \
            --exclude='composer.json' \
            --exclude='composer.lock' \
            --exclude='.editorconfig' \
            --exclude='*.md' \
            --exclude='test-*.php' \
            --exclude='verify-*.php' \
            --exclude='standalone-test.php' \
            --exclude='.plans' \
            --exclude='.logs' \
            --exclude='.t2' \
            --exclude='.implementation-notes' \
            --exclude='tasks.csv' \
            --exclude='RELEASE_CHECKLIST.md' \
            . build/whatsapp-commerce-hub/

          # Remove .git directories from vendor
          find build/whatsapp-commerce-hub/vendor -type d -name '.git' -exec rm -rf {} + 2>/dev/null || true

          # Create ZIP
          cd build
          zip -r ../whatsapp-commerce-hub-${{ steps.get_version.outputs.VERSION }}.zip whatsapp-commerce-hub
          cd ..

          # Calculate checksum
          sha256sum whatsapp-commerce-hub-${{ steps.get_version.outputs.VERSION }}.zip > whatsapp-commerce-hub-${{ steps.get_version.outputs.VERSION }}.zip.sha256

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}

          # Extract changelog section for this version from CHANGELOG.md
          awk '/^## \['$VERSION'\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md > release-notes.md

          # If no changelog found, create a generic one
          if [ ! -s release-notes.md ]; then
            echo "Release version $VERSION" > release-notes.md
            echo "" >> release-notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: |
            whatsapp-commerce-hub-${{ steps.get_version.outputs.VERSION }}.zip
            whatsapp-commerce-hub-${{ steps.get_version.outputs.VERSION }}.zip.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to WordPress.org (Optional)
        if: ${{ secrets.WP_ORG_SVN_USERNAME != '' && secrets.WP_ORG_SVN_PASSWORD != '' }}
        run: |
          # This is optional and requires WordPress.org SVN credentials
          # Set WP_ORG_SVN_USERNAME and WP_ORG_SVN_PASSWORD as repository secrets

          VERSION=${{ steps.get_version.outputs.VERSION }}

          # Install SVN
          sudo apt-get update
          sudo apt-get install -y subversion

          # Checkout SVN repository
          svn co https://plugins.svn.wordpress.org/whatsapp-commerce-hub svn --username=${{ secrets.WP_ORG_SVN_USERNAME }} --password=${{ secrets.WP_ORG_SVN_PASSWORD }} --non-interactive

          # Clear trunk
          rm -rf svn/trunk/*

          # Copy plugin files to trunk
          cp -r build/whatsapp-commerce-hub/* svn/trunk/

          # Add all new files
          cd svn/trunk
          svn add --force * --auto-props --parents --depth infinity -q

          # Remove deleted files
          svn status | grep '^!' | awk '{print $2}' | xargs -r svn delete

          # Commit to trunk
          svn ci -m "Update to version $VERSION" --username=${{ secrets.WP_ORG_SVN_USERNAME }} --password=${{ secrets.WP_ORG_SVN_PASSWORD }} --non-interactive

          # Create tag
          cd ..
          svn cp trunk tags/$VERSION
          svn ci -m "Tagging version $VERSION" --username=${{ secrets.WP_ORG_SVN_USERNAME }} --password=${{ secrets.WP_ORG_SVN_PASSWORD }} --non-interactive

          # Update assets if they exist
          if [ -d "../.wordpress-org" ]; then
            mkdir -p assets
            cp ../.wordpress-org/*.png assets/ 2>/dev/null || true
            cp ../.wordpress-org/*.jpg assets/ 2>/dev/null || true
            cp ../.wordpress-org/*.svg assets/ 2>/dev/null || true
            svn add --force assets/* --auto-props --parents --depth infinity -q
            svn ci -m "Update plugin assets for version $VERSION" --username=${{ secrets.WP_ORG_SVN_USERNAME }} --password=${{ secrets.WP_ORG_SVN_PASSWORD }} --non-interactive
          fi
        env:
          WP_ORG_SVN_USERNAME: ${{ secrets.WP_ORG_SVN_USERNAME }}
          WP_ORG_SVN_PASSWORD: ${{ secrets.WP_ORG_SVN_PASSWORD }}

  notify:
    name: Post-Release Notification
    runs-on: ubuntu-latest
    needs: release
    if: always()

    steps:
      - name: Check release status
        run: |
          if [ "${{ needs.release.result }}" == "success" ]; then
            echo "Release completed successfully!"
          else
            echo "Release failed!"
            exit 1
          fi
